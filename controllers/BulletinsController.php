<?php

/**
 * @copyright MIDASGEN
 */

Class BulletinsController extends Controller{
public function __construct(){
	parent::__construct();	$this->view->js = array('js/jquery.js','js/jqueryui.js','js/vegas.js');		parent::loginRedirect();	
}

public function beforeFilter(){}
public function xcloseEvent(){$dbo=PDBO;$eid = $_POST['eid'];$od  = $_POST['od']; $today = date('Y-m-d');$q = " UPDATE ".DBG.".bulletins SET `overdays` = '$od', `closed` = '$today', `cstatus_id` = '2' WHERE `id` = '$eid' LIMIT 1; ";$_SESSION['q'] = $q;$this->Bulletin->db->query($q);}	/* fxn */public function searchBulletin($params){		$dbo=PDBO;	$params = rally('stripslashes',$params);		$conditions = (isset($params['cstatus_id']) && ($params['cstatus_id']))? " AND b.`cstatus_id` = '".$params['cstatus_id']."' " : " ";					if (!empty($params['ctag'])){ $conditions .= " AND b.`ctag_id` = '".$params['ctag']."' "; }					if (!empty($params['info'])){ $conditions .= " AND b.`info` LIKE '%".$params['info']."%' "; }					return $conditions; }public function index($params=NULL){$dbo=PDBO;$page 	 	= isset($params[0])? $params[0] : 1;$room_id 	= $_GET['circle'];$user 		= $_SESSION['user'];$uroom_ids 	= $_SESSION['uroom_ids'];IF(!in_array($room_id,$uroom_ids)){ $this->flashRedirect('circles','Not allowed.'); } /* conditions for search */$_SESSION['get'] 		= $_GET;	$condition = $this->searchBulletin($_SESSION['get']);if(isset($_GET['page'])) {	$page = $_GET['page'];	unset($_GET['page']);	unset($_GET['submit']);	$get = sages($_GET);				$get = rtrim($get,'&');	$url = "bulletins/index/".$page.$get;	redirect($url);}$data['room'] = $room = $this->Bulletin->row("{$dbo}.rooms",$room_id);/* ---------------------------------------------------------------------------------------------------------- */	/* sort */	$sort = isset($_GET['sort'])? $_GET['sort'] : 'b.`date` ';	$order = $_SESSION['order'];	/*  PAGINATION */	$page     = isset($page) ? $page : 1;												/*  1 of 3 */	$numrows  = isset($_GET['numrows'])? $_GET['numrows'] : NUMROWS;	$_SESSION['numrows'] = isset($numrows)? $numrows : NUMROWS;	$perPage  = ($_SESSION['numrows'] < NUMROWS)? $_SESSION['numrows']: NUMROWS;		/*  2 of 3 */	$offset   = ($page - 1) * $perPage;													/*  3 of 3 */	$loggedin = loggedin();/* ---------------------------------------------------------------------------------------------------------- */$q = " SELECT b.*, uc.account AS owner, ct.`name` AS 'ctag', cs.`name` AS status, cs.`code` AS status_code 	FROM {$dbg}.`bulletins` AS `b`		LEFT JOIN {$dbo}.`00_contacts` AS `uc` ON b.`ucid` = uc.`id` 		LEFT JOIN {$dbo}.`rooms` AS `r` ON b.`room_id` = r.`id` 		LEFT JOIN {$dbo}.`ctags` AS `ct` ON b.`ctag_id` = ct.`id` 		LEFT JOIN {$dbg}.`cstatuses` AS `cs` ON b.`cstatus_id` = cs.`id` 	WHERE 	r.`id` = '$room_id'		$condition";	$totalCount = $this->Bulletin->countAll($q);			$pagination = new Pagination($page, $perPage, $totalCount);		$data['pages'] = $pagination->pageNav('bulletins');		$data['num_pages']	= count($data['pages']);	$q .= " LIMIT $perPage OFFSET {$offset} ; ";			// echo "<br />q: $q <br />";								$data['q'] = $q;	$sth = $this->Bulletin->db->querysoc($q);	$data['bullets'] 	= $sth->fetchAll();	$data['cstatuses'] 	= $this->Bulletin->noel(PDBG.'.cstatuses');	$data['ctags'] 		= $this->Bulletin->noel(PDBG.'.ctags',$fields="*",$order="name",$where=" WHERE `ctagcategory_id` = '".$room['ctagcategory_id']."' ");	$this->view->render($data,'bulletins/index');}	/* fxn */public function add($params){$dbo=PDBO;$dbg=PDBG;$room_id 	  = $params[0];$data['room'] = $room 	 = $this->Bulletin->row("{$dbg}.rooms",$room_id);$user = $_SESSION['user'];$ucid = $user['ucid'];$uroom_ids = $_SESSION['uroom_ids'];IF(!in_array($room_id,$uroom_ids)){ Session::set('message','Not allowed.'); redirect('index'); } $unixtime 	= time();$time 		= date('H:i:s',$unixtime);if(isset($_POST['add'])){	$rows = $_POST['bullets'];	// pr($rows);	$q = "";	foreach($rows AS $row){		$cstatus_id = $row['cstatus_id'];		$info		= $row['info'];		$date		= $row['date'];		$ctagid		= $row['ctag_id'];		$q .= " INSERT INTO {$dbg}.bulletins (`date`,`time`,`ucid`,`room_id`,`cstatus_id`,`info`,`ctag_id`)  			VALUES('$date','$time','$ucid','$room_id','$cstatus_id','$info','$ctagid');";	}	// pr($q); exit;	$this->Bulletin->db->query($q);	redirect('bulletins/index/1?circle='.$room_id);	exit;}	/* post */$data['ctags'] 		= $this->Bulletin->noel(PDBG.'.ctags',$fields="*",$order="name",$where=" WHERE `ctagcategory_id` = '".$room['ctagcategory_id']."' ");$data['cstatuses'] 	= $this->Bulletin->noel(PDBG.'.cstatuses',$fields="*");$this->view->render($data,'bulletins/add');}	/* fxn */private function getBulletin($bid){	$q = " SELECT 			b.`id` AS `bid`, b.*, r.`ctagcategory_id` AS `ctcid`, ctc.`name` AS `ctc`, ct.`name` AS ctag,			cs.`name` AS `cstatus`, c.`code` AS `owner`,r.`name` AS room 		FROM ".DBG.".`bulletins` AS `b` 			LEFT JOIN ".DBG.".`00_contacts` AS `c` ON b.`ucid` = c.`id`			LEFT JOIN ".DBG.".`rooms` AS `r` ON b.`room_id` = r.`id`			LEFT JOIN ".DBG.".`ctagcategories` AS `ctc` ON r.`ctagcategory_id` = ctc.`id`			LEFT JOIN ".DBG.".`ctags` AS `ct` ON b.`ctag_id` = ct.`id`			LEFT JOIN ".DBG.".`cstatuses` AS `cs` ON b.`cstatus_id` = cs.`id`		WHERE b.`id` = '$bid' LIMIT 1;	";	$sth = $this->Bulletin->db->querysoc($q);	return $sth->fetch();}public function view($params){$dbo=PDBO;$bid 	= $params[0];$user 	= $_SESSION['user'];$ucid 	= $user['ucid'];$uroom_ids = $_SESSION['uroom_ids'];$data['bulletin'] 		= $bulletin = $this->getBulletin($bid);$data['room_id'] 		= $room_id = $bulletin['room_id'];$data['bb'] 	  	  	= $this->Bulletin->rowByCondition(PDBG.'.bullbodies'," WHERE `bulletin_id` = '$bid' ");$data['bullbody'] 	  	= $bullbody = $data['bb']['body'];$data['has_bullbody'] 	= empty($data['bb'])? false:true;$today				  	= date('D M d, Y H:i');$in_circle 	= (in_array($room_id,$uroom_ids))? true : false;$is_mis  	= ($user['role_id']==RMIS);if(!$in_circle && !$is_mis){ $this->flashRedirect('circles'); } if(isset($_POST['submit'])){	$reply			= $_POST['bb']['reply'];	$bb['body']		= $today.' by '.$user['username'].'<br />'.$reply.$bullbody;		$this->Bulletin->db->update(PDBG.'.bullbodies',$bb," `bulletin_id` = $bid ");	$url = "bulletins/index/1?circle=$room_id";	redirect($url);		exit;}$data['ctags'] 		= $this->Bulletin->noel(PDBG.'.ctags',$fields="*",$order="name",$where=" WHERE `ctagcategory_id` = '".$bulletin['ctcid']."' ");$data['cstatuses'] 	= $this->Bulletin->noel(PDBG.'.cstatuses',$fields="*","id"," WHERE `id` != '2'  ");$this->view->render($data,'bulletins/view','editor');}	/* fxn */public function edit($params){$dbo=PDBO;$bid 	= $params[0];$user 	= $_SESSION['user'];$ucid 	= $user['ucid'];$uroom_ids = $_SESSION['uroom_ids'];$data['bulletin'] 		= $bulletin = $this->getBulletin($bid);$data['room_id'] 		= $room_id = $bulletin['room_id'];$data['bb'] 	  	  	= $this->Bulletin->rowByCondition(PDBG.'.bullbodies'," WHERE `bulletin_id` = '$bid' ");$data['bullbody'] 	  	= $bullbody = $data['bb']['body'];$data['has_bullbody'] 	= empty($data['bb'])? false:true;$today				  	= date('D M d, Y H:i');$in_circle 	= (in_array($room_id,$uroom_ids))? true : false;$is_mis  	= ($user['role_id']==RMIS);if(!$in_circle && !$is_mis){ $this->flashRedirect('circles'); } if(isset($_POST['submit'])){		$bulletin 	= $_POST;	$bb  		= $bulletin['bb'];	unset($bulletin['submit']);	unset($bulletin['bb']);		$bb['body']	= $today.' by '.$user['username'].'<br />'.$bb['body'];			$this->Bulletin->db->update(PDBG.'.bulletins',$bulletin," `id` = $bid ");	$this->Bulletin->db->update(PDBG.'.bullbodies',$bb," `bulletin_id` = $bid ");	$url = "bulletins/index/1?circle=$room_id";	redirect($url);		exit;}$data['ctags'] 		= $this->Bulletin->noel(PDBG.'.ctags',$fields="*",$order="name",$where=" WHERE `ctagcategory_id` = '".$bulletin['ctcid']."' ");$data['cstatuses'] 	= $this->Bulletin->noel(PDBG.'.cstatuses',$fields="*");$this->view->render($data,'bulletins/edit','editor');}	/* fxn */
public function xaddBullbody(){		$dbo=PDBO;	$bid 	= $_POST['bid'];	$q  = " UPDATE ".PDBG.".bulletins SET `has_body` = '1' WHERE `id` = '$bid' LIMIT 1; "; 	$q .= " INSERT INTO ".PDBG.".bullbodies (`bulletin_id`) VALUES ('$bid'); ";	$this->Bulletin->db->query($q);	$_SESSION['q'] = $q;}	/* fxn */public function xdeleteBullbody(){		$dbo=PDBO;	$bid 	= $_POST['bid'];	$q  = " DELETE FROM ".PDBG.".bullbodies WHERE `bulletin_id` = '$bid' LIMIT 1; ";	$q .= " UPDATE ".PDBG.".bulletins SET `has_body` = '0' WHERE `id` = '$bid' LIMIT 1; "; 	$this->Bulletin->db->query($q);	}	/* fxn */public function xdeleteBulletin(){		$dbo=PDBO;	$bid 	= $_POST['bid'];	$q   = " DELETE FROM ".PDBG.".bullbodies WHERE `bulletin_id` = '$bid' LIMIT 1; ";	$q  .= " DELETE FROM ".PDBG.".bulletins WHERE `id` = '$bid' LIMIT 1; ";	$this->Bulletin->db->query($q);	}	/* fxn */
} /* BulletinsCtlr */

