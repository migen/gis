<?php
/**
 * @copyright MIDASGEN
 */

Class RoomsController extends Controller{
public function __construct(){
	parent::__construct();	parent::loginRedirect();	// $acl = array(array(5,0));	// $this->permit($acl);						
}

public function beforeFilter(){}
public function index(){			$q = "		SELECT r.*,c.name AS owner		FROM {$dbo}.rooms AS r			LEFT JOIN {$dbo}.`00_contacts` AS c ON r.owner_pcid = c.id		ORDER BY r.name			;						";	$sth = $this->Room->db->querysoc($q);	$data['rooms'] = $sth->fetchAll();	$data['rooms']	= $_SESSION['urooms'];	$data['numrows'] = count($data['rooms']);	$data['is_mis']	 = ($_SESSION['user']['role_id']==RMIS)? true:false;			$this->view->render($data,'rooms/index');}	/* fxn */public function edit($params){$dbo=PDBO;$this->view->js = array('js/jquery.js','js/jqueryui.js','js/vegas.js');	$rid = $params[0];if(isset($_POST['submit'])){	unset($_POST['submit']);	$row = $_POST;	$this->Room->db->update(DBO.".rooms",$row," `id` = $rid ");	redirect('users/reset/rooms');}$data['room'] = $this->Room->fetchRow(DBO.'.rooms',$rid);$data['ctc']  = $this->Room->fetchRows(DBO.'.ctagcategories');$this->view->render($data,'rooms/edit');}public function members($params){$dbo=PDBO;$room_id = $params[0];$user	 = $_SESSION['user']; $scid	 = $user['ucid'];$mis	 = ($user['role_id']==RMIS)? true:false;$data['room'] = $room = $this->Room->fetchRow(DBO.'.rooms',$room_id);$owner	 = ($room['owner_ucid']==$scid)? true:false;$q = "	SELECT 		c.`id` AS `ucid`,c.`name` AS `member`,rc.`id` AS `rcid`	FROM {$dbo}.`00_contacts` AS c 		INNER JOIN {$dbo}.rooms_contacts AS rc ON rc.`contact_id` = c.`id`	WHERE rc.`room_id` = '$room_id'";$sth = $this->Room->db->querysoc($q);$data['members'] = $sth->fetchAll();$data['numrows'] = count($data['members']);$data['member_ids'] = $member_ids	= buildArray($data['members'],'ucid');$belong = in_array($scid,$member_ids)? true:false;if(!$mis && !$owner && !$belong){ $this->flashRedirect('rooms'); }if(isset($_POST['add'])){	$rows 	 = $_POST['members'];	$room_id = $_POST['room_id'];	$q = "";	foreach($rows AS $row){		$q .= " INSERT INTO {$dbo}.rooms_contacts (`room_id`,`contact_id`) VALUES ('$room_id','".$row['ucid']."');  "; 	}	$this->Room->db->query($q);	redirect('rooms/members/'.$room_id);	}$data['contacts'] = $this->Room->fetchRows(PDBO.'.`00_contacts`',"id,name","name"," WHERE (id=parent_id) AND `is_active` = '1' ");$this->view->render($data,'rooms/members');}	/* fxn */public function removeMember($params){$dbo=PDBO;$room_id 	= $params[0];$rcid 		= $params[1];$user	= $_SESSION['user'];$urid 	= $user['role_id'];if($urid!=RMIS){ redirect('rooms/members/'.$room_id); }$this->Room->db->delete($rcid, DBO.".rooms_contacts");redirect('rooms/members/'.$room_id);}	/* fxn */public function all(){	$dbo=PDBO;$roles = array(array(5,0));$this->permit($roles);					$q = "				SELECT r.name AS room,ctc.`id` AS `ctcid`,ctc.name AS ctc 		FROM {$dbo}.rooms AS r			LEFT JOIN {$dbo}.`00_contacts` AS c ON r.owner_ucid = c.id					LEFT JOIN {$dbo}.ctagcategories AS ctc ON r.ctagcategory_id = ctc.id				ORDER BY r.name;						";	$sth = $this->Room->db->querysoc($q);	$data['rooms'] = $sth->fetchAll();	$data['numrows'] = count($data['rooms']);			$this->view->render($data,'rooms/index');}	/* fxn */
} /* RoomsCtlr */

