<?php

/**
 * @copyright MIDASGEN
 */

Class AgendaController extends Controller{
public function __construct(){
	parent::__construct();	$this->view->js = array('js/jquery.js','js/jqueryui.js','js/vegas.js');		parent::loginRedirect();	
}

public function beforeFilter(){}
public function searchAgenda($params){		$dbo=PDBO;	$params = rally('stripslashes',$params);		$user	= $_SESSION['user'];	$ucid	= $user['ucid'];	$mis	= ($user['role_id']==RMIS)? true:false;		$conditions = (isset($params['status']) && ($params['status']))? " AND a.`status` = '".$params['status']."' " : " ";					$public 	= (isset($params['public']) && ($params['public']!=''))? $params['public']:NULL;	$conditions .= isset($public)? " AND a.`is_public` = '".$public."' ":NULL;		$conditions .= (!$mis)? " AND ((a.`ucid` = '".$ucid."') || (a.`is_public` != 0) )":NULL; 				if (!empty($params['agenda'])){ $conditions .= " AND a.`agenda` LIKE '%".$params['agenda']."%' "; }					return $conditions; }public function view($params=NULL){$dbo=PDBO;require_once(SITE."functions/arrays.php");$db =& $this->model->db;$page 	 	= isset($params[0])? $params[0] : 1;$ssy		= $_SESSION['sy'];$sy 	 	= isset($params[1])? $params[1] : $ssy;$dbg	= VCPREFIX.$sy.US.DBG;$data['room_id']	= $room_id 	= $_GET['room'];$data['user']		= $user 		= $_SESSION['user'];$uroom_ids 		= $_SESSION['uroom_ids'];$data['mis']	= $mis 	= ($user['role_id']==RMIS)? true:false;// IF(!in_array($room_id,$uroom_ids) || (!$is_mis)){ $this->flashRedirect('rooms','Not allowed.'); } IF(!in_array($room_id,$uroom_ids) AND (!$mis)){ $this->flashRedirect('rooms'); } /* conditions for search */$_SESSION['get'] 		= $_GET;	$condition = $this->searchAgenda($_SESSION['get']);if(isset($_GET['page'])) {	$page = $_GET['page'];	unset($_GET['page']);	unset($_GET['submit']);	$rget = trimGet($_GET);	$get = sages($rget);				$get = rtrim($get,'&');	$url = "agenda/view/".$page.$get;	redirect($url);}$data['room'] = $room = $this->Agenda->fetchRow(DBO.'.rooms',$room_id);/* ---------------------------------------------------------------------------------------------------------- */	/* sort */	$sort = isset($_GET['sort'])? $_GET['sort'] : 'a.`date` ';	$order = $_SESSION['order'];	$snr = $_SESSION['settings']['numrows'];		/*  PAGINATION */	$numrows  			= isset($_GET['numrows'])? $_GET['numrows'] : $snr;	$data['perPage']	= $perPage  =	$_SESSION['numrows'] = $numrows;	$offset   = ($page - 1) * $perPage;													/*  3 of 3 */	$loggedin = loggedin();/* ---------------------------------------------------------------------------------------------------------- */$q = " SELECT 		a.*,a.id AS aid,		c.name AS user	FROM {$dbg}.`agenda` AS `a`		LEFT JOIN {$dbo}.`00_contacts` AS `c` ON a.`ucid` = c.`id` 		LEFT JOIN {$dbo}.`rooms` AS `r` ON a.`room_id` = r.`id` 	WHERE 	r.`id` = '$room_id'		$condition";	$totalCount = $this->Agenda->countAll($q);			$pagination = new Pagination($page, $perPage, $totalCount);		$data['pages'] = $pagination->pageNav('agenda','view');		$data['num_pages']	= count($data['pages']);	$q .= " LIMIT $perPage OFFSET {$offset} ; ";			// echo "<br />q: $q <br />";								$data['q'] = $q;	$sth = $this->Agenda->db->querysoc($q);	$data['agenda'] 	= $sth->fetchAll();	$data['numrows']	= count($data['agenda']);		$data['statuses'] = array(		array('id'	=> 'closed','name' => 'closed'), 		array('id'	=> 'active','name' => 'active'), 		array('id'	=> 'other','name' => 'other'), 	);	$data['members'] = isset($_SESSION['room'][$room_id]['members'])? 		$_SESSION['room'][$room_id]['members']:$this->Agenda->sessionizeMembers($room_id); 		$this->view->render($data,'agenda/view');}	/* fxn */public function add($params){$dbo=PDBO;if(!isset($params)) $this->flashRedirect('rooms');$data['room_id']	= $room_id = $params[0];$data['ucid']		= $_SESSION['user']['ucid'];$data['edit']	= false;if(isset($_POST['submit'])){	// pr($_POST);	$row = $_POST['agenda'];	$this->Agenda->db->add(DBG.'.agenda',$row);	$url = 'rooms';	redirect($url);	exit;}	/* post */$this->view->render($data,'agenda/form');}	/* fxn */public function edit($params){$dbo=PDBO;require_once(SITE.'functions/misFxn.php');$data['aid']		= $aid 	= $params[0];$data['ssy']		= $ssy	= $_SESSION['sy'];$data['sy']			= $sy	= isset($params[1])? $params[1]:$ssy;$dbg	= VCPREFIX.$sy.US.DBG;$q = " SELECT a.*,c.name AS user	FROM {$dbg}.agenda AS a		LEFT JOIN {$dbo}.`00_contacts` AS c ON a.ucid = c.id	WHERE a.id = '$aid' LIMIT 1;";$sth 			 = $this->Agenda->db->querysoc($q);$data['agenda']	 = $agenda = $sth->fetch();$data['room_id'] = $room_id = $agenda['room_id'];$page			 = isset($_SESSION['agenda']['page'])? $_SESSION['agenda']['page']:1;$data['ucid']		= $ucid	= $agenda['ucid'];$data['scid']		= $scid	= $_SESSION['user']['ucid'];if(!isMIS() && ($ucid!=$scid)) { $this->flashRedirect('rooms'); } $data['edit']	= true;if(isset($_POST['submit'])){// pr($_POST);// exit;$row = $_POST['agenda'];$this->Agenda->db->update($dbg.'.agenda',$row,"id=$aid");$url = "agenda/view/$page?room=$room_id";redirect($url);}	/* post */$this->view->render($data,'agenda/form');}	/* fxn */
} /* BulletinsCtlr */

