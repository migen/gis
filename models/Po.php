<?php
class Po extends Model{

public function __construct(){
	parent::__construct();
}
public function edit($posts,$old,$dbg=PDBG){	$dbo=PDBO;			$pos = $posts['pos'];	$positems = $posts['positems'];	$tml = $pos['terminal'];			/* 1 - edit pos */		$pos_id = $pos['id'];	$pos['is_paid'] = ($pos['is_credit']==1)? 0:1;		$this->db->update("{$dbo}.`30_pos`",$pos,"`id`='".$pos_id."'");		// pr($old); exit;	/* 2 - a) delete old details, b) adjust inventory */ 	$q = "DELETE FROM {$dbo}.`30_positems` WHERE `pos_id` = '$pos_id'; ";foreach($old AS $row){	if($row['io']==1){ 			if(isset($row['oldprid']) && ($row['oldqty'])){		    $q .= "UPDATE {$dbo}.`03_products` SET level = level+".$row['oldqty'].",`t{$tml}` = `t{$tml}` +".$row['oldqty']." 			   WHERE `id`='".$row['oldprid']."' LIMIT 1;";							/* 2 - combo */			$combos = trim($row['oldcombo']);			// pr($row);			$combor = array_filter(explode(',',$combos));			foreach($combor AS $cid){					// pr($combor);				$q .= "UPDATE {$dbo}.`03_products` SET level = level+".$row['oldqty'].",`t{$tml}` = `t{$tml}` +".$row['oldqty']." 					WHERE `id`='".$cid."' LIMIT 1;";			}		  				}		}	/* if io */						}	/* old */		/* 3 - insert new positems */		$q .= "INSERT INTO {$dbo}.`30_positems`(`pos_id`,`product_id`,`price`,`qty`,`amount`) VALUES ";	foreach($positems AS $row){				if($row['io']==1){ 			$q .= " ('$pos_id','".$row['product_id']."','".$row['price']."','".$row['qty']."','".$row['amount']."'),";			}				  	  	  	}	/* new */		$q = rtrim($q,",");	$q .= ";";			/* 4 - adjust inventory */	foreach($positems AS $row){					if($row['io']==1){ 			  $q .= "UPDATE {$dbo}.`03_products` SET level = level-".$row['qty'].",`t{$tml}` = `t{$tml}` -".$row['qty']." 			WHERE `id`='".$row['product_id']."' LIMIT 1;";						/* 2 - combo */			$combos = trim($row['combo']);			$combor = array_filter(explode(',',$combos));			foreach($combor AS $cid){						$q .= "UPDATE {$dbo}.`03_products` SET level = level-".$row['qty'].",`t{$tml}` = `t{$tml}` -".$row['qty']." 					WHERE `id`='".$cid."' LIMIT 1;";			}		  		}							}	/* new levels */		// pr($q); exit;		$this->db->query($q);}	/* fxn */public function myTerminal(){	$terminal = (isset($_SESSION['terminal']))? $_SESSION['terminal']:$this->getMyTerminal();	return $terminal;	}	/* fxn */private function getMyTerminal0(){	$gisfile = "c://system files/bin/gis.php";	include_once($gisfile);		$_SESSION['terminal'] = $terminal;	// echo "getMyTerm fxn called";	return $terminal;}private function getMyTerminal($dbg=PDBG){		$dbo=PDBO;		$ecid = $_SESSION['pcid'];	$q = "SELECT * FROM {$dbo}.`03_terminals_employees` WHERE `ecid` = '$ecid' LIMIT 1; ";	$sth = $this->db->querysoc($q);	$row = $sth->fetch();	$terminal = $row['terminal'];	$_SESSION['terminal'] = $terminal;	return $terminal;}	/* fxn */
}  /* Po */